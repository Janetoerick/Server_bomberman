<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <style type="text/css">
        #chat_total {
            width: 500px;
        }
    </style>
</head>
<body onload="getUser()">
    <div id="chat_total">
        <!-- <div id="users_logged">
            <p>Usu√°rios logados:</p>
            <select multiple="multiple" id='users_list'>
            </select>
        </div> -->
        <div id="history_messages"><p id="test"></p>
        </div>
        <div id="chat">
            <input type='text' id='message_text' name='message_text' />
            <input type='submit' value='Enviar mensagem' onClick="sendMessage()"/>
        </div>
    </div>

    
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

    <script type="text/javascript">
        var socket = new WebSocket("ws://" + location.host);
        let user;
        socket.onmessage = (event) => {        
            const json = JSON.parse(event.data);

            if (json.type == 'setUser') {
                console.log(json.data);
                user = json.data;
            } else if (json.type == 'setMessage') {
                var newtext = document.createElement("p");
                var text = document.createTextNode(json.data);

                newtext.appendChild(text);
                document.getElementById("history_messages").appendChild(newtext);
            } else if (json.type == 'introNewUser') {
                var newtext = document.createElement("option");
                var text = document.createTextNode(json.data);

                newtext.appendChild(text);
                document.getElementById("multiple").appendChild(newtext);
            }
        }

        function sendMessage(){
            var message = document.getElementById("message_text").value;
            if(message != ''){
                document.getElementById("message_text").value = "";
                socket.send(JSON.stringify({
                    inGame: "false",
                    type:"setMessage",
                    username: user,
                    message: message
                }));
            } else {
                alert("Digite algo antes de enviar a mensagem!");
            }
        }

        function getUser(){
            socket.send(JSON.stringify({
                inGame: "false",
                type:"getUser",
            })); 
        }
    </script>
</body>
</html>